# ğŸ—‘ï¸ GKE Cleanup Guide

## Overview

The `cleanup-gke.sh` script safely deletes all Google Cloud resources created by `setup-gke.sh`.

**Use this when:**
- Testing/development is complete
- Want to stop monthly costs (~$100-300)
- Need to start fresh
- Removing the project entirely

---

## ğŸš€ Quick Start

```bash
./cleanup-gke.sh
```

**What it does:**
1. Loads your configuration from `gke-config.txt` (auto-detect)
2. Shows exactly what will be deleted
3. Calculates cost savings
4. Asks for double confirmation
5. Deletes resources in safe order
6. Backs up your config file

---

## ğŸ“Š What Gets Deleted

### Resources
- âœ… **GKE Cluster** - All pods, services, deployments
- âœ… **Artifact Registry** - Docker images repository
- âœ… **Workload Identity Provider** - GitHub OIDC connection
- âœ… **Workload Identity Pool** - Identity federation pool
- âœ… **Service Account** - Deployment service account

### What STAYS
- âŒ GCP Project (you can delete manually if needed)
- âŒ Billing account
- âŒ GitHub repository
- âŒ GitHub secrets

---

## ğŸ’° Cost Impact

| Resource | Monthly Cost | After Cleanup |
|----------|--------------|---------------|
| **GKE Cluster (Zonal)** | ~$100/mo | âœ… $0 |
| **GKE Cluster (Regional)** | ~$300/mo | âœ… $0 |
| **Artifact Registry** | ~$5-20/mo | âœ… $0 |
| **Service Account** | Free | âœ… $0 |
| **Workload Identity** | Free | âœ… $0 |

**Total Savings:** ~$100-320/month

---

## ğŸ”’ Safety Features

### Double Confirmation
```bash
Type 'DELETE' to confirm deletion: DELETE
Are you ABSOLUTELY sure? (yes/no): yes
```

Both prompts required - prevents accidental deletion!

### Preview Before Deletion
Shows exactly what exists and will be deleted:
```
Resources to be DELETED:

   ğŸ—‘ï¸  GKE Cluster: dadismad-cluster-1 (zonal - us-central1-a)
   ğŸ—‘ï¸  Artifact Registry: dadismad (us-central1)
   ğŸ—‘ï¸  Workload Identity Provider: github-provider
   ğŸ—‘ï¸  Workload Identity Pool: github-actions-pool
   ğŸ—‘ï¸  Service Account: dadismad-github-actions@project.iam.gserviceaccount.com

ğŸ’° Cost Savings:
   Zonal cluster: ~$100/month saved

âš ï¸  This action CANNOT be undone!
âš ï¸  All data will be permanently lost!
```

### Config Backup
Your `gke-config.txt` is backed up as `gke-config.txt.backup-TIMESTAMP`

---

## ğŸ“ Usage Examples

### Standard Cleanup (with config file)

```bash
# If you have gke-config.txt (auto-generated by setup-gke.sh)
./cleanup-gke.sh

# Confirms project and cluster from config
# Shows preview
# Asks for confirmation
# Deletes resources
```

### Manual Cleanup (without config file)

```bash
# If you don't have gke-config.txt
./cleanup-gke.sh

# Shows list of your GCP projects
# You enter project ID manually
# Asks if cluster is regional or zonal
# Continues as normal
```

---

## â±ï¸ How Long Does It Take?

| Step | Time | Note |
|------|------|------|
| **GKE Cluster** | 3-5 min | Longest step - drains nodes |
| **Artifact Registry** | 10-30 sec | Depends on # of images |
| **Workload Identity** | 5-10 sec | Fast deletion |
| **Service Account** | 5-10 sec | Fast deletion |
| **Total** | ~5-7 min | Grab a coffee â˜• |

---

## ğŸ”„ Re-deploying After Cleanup

Want to deploy again later? Easy!

```bash
# Clean up everything
./cleanup-gke.sh

# Later... re-deploy
./setup-gke.sh

# Your GitHub repo is untouched
# Just add the GitHub secrets again
```

---

## ğŸ†˜ Troubleshooting

### "Cannot find cluster"
**Cause:** Cluster name or location mismatch

**Fix:**
```bash
# List your clusters
gcloud container clusters list

# Use the correct name/location when prompted
```

### "Permission denied"
**Cause:** Not logged into gcloud or wrong project

**Fix:**
```bash
gcloud auth login
gcloud config set project YOUR_PROJECT_ID
```

### "Resource is being used"
**Cause:** Resources have dependencies

**Fix:** Script handles this! Deletes in correct order:
1. Cluster (no dependencies)
2. Registry (no dependencies)
3. Provider (before pool)
4. Pool (before service account)
5. Service Account (last)

### Script Hangs on Cluster Deletion
**Cause:** Large cluster takes time to drain

**Expected:** Up to 5 minutes is normal  
**Wait:** Let it finish - interrupting can leave orphaned resources

---

## ğŸ›¡ï¸ What If Something Goes Wrong?

### Partial Deletion
If the script fails mid-way, just run it again:
```bash
./cleanup-gke.sh
```

It checks what exists and only tries to delete what's there.

### Manual Cleanup (Emergency)

If the script fails completely, manual cleanup:

```bash
# 1. Delete cluster
gcloud container clusters delete dadismad-cluster-1 \
  --zone=us-central1-a  # or --region=us-central1

# 2. Delete registry
gcloud artifacts repositories delete dadismad \
  --location=us-central1

# 3. Delete provider
gcloud iam workload-identity-pools providers delete github-provider \
  --workload-identity-pool=github-actions-pool \
  --location=global

# 4. Delete pool
gcloud iam workload-identity-pools delete github-actions-pool \
  --location=global

# 5. Delete service account
gcloud iam service-accounts delete \
  dadismad-github-actions@PROJECT_ID.iam.gserviceaccount.com
```

---

## ğŸ’¡ Pro Tips

### Keep the Project, Delete Resources Only
The script deletes resources but keeps your project. Benefits:
- No project ID re-creation needed
- Billing account stays linked
- APIs stay enabled
- Faster re-deployment

### Delete Project Too (Complete Cleanup)
After running the script:
```bash
# Delete the entire project
gcloud projects delete YOUR_PROJECT_ID

# This removes EVERYTHING including:
# - All resources
# - All data
# - Project billing
```

### Cost Monitoring Before Cleanup
Check your current costs:
```bash
# Go to: https://console.cloud.google.com/billing

# Or use CLI
gcloud billing accounts list
```

---

## ğŸ“‹ Cleanup Checklist

Before running cleanup:

- [ ] Export any important data from cluster
- [ ] Backup any custom Docker images
- [ ] Note your project ID (in case you need it)
- [ ] Remove GitHub secrets (optional - they're harmless)
- [ ] Document any custom configurations

After cleanup:

- [ ] Verify resources deleted in GCP Console
- [ ] Check billing to confirm charges stopped
- [ ] Delete project if you don't need it
- [ ] Keep `gke-config.txt.backup-*` for reference

---

## ğŸ¯ Summary

| Command | Purpose | Time | Cost Impact |
|---------|---------|------|-------------|
| `./cleanup-gke.sh` | Delete all GKE resources | ~5-7 min | Save ~$100-300/mo |
| `gcloud projects delete PROJECT_ID` | Delete entire project | ~30 sec | Complete cleanup |
| `./setup-gke.sh` | Re-deploy everything | ~15-20 min | Resume costs |

---

## â“ FAQ

**Q: Can I cancel mid-deletion?**  
A: Yes, press Ctrl+C. Already-deleted resources won't come back, but remaining resources will stay.

**Q: Will this delete my code?**  
A: No! Your GitHub repository is completely safe.

**Q: What about the GitHub secrets?**  
A: They remain in GitHub. Harmless but you can manually delete them in Settings â†’ Secrets.

**Q: Can I delete just the cluster and keep other resources?**  
A: Not with this script. For selective deletion, use manual `gcloud` commands.

**Q: How do I know deletion worked?**  
A: Check the GCP Console or run:
```bash
gcloud container clusters list
gcloud artifacts repositories list
```

**Q: Does this affect billing immediately?**  
A: Yes! Billing stops as soon as resources are deleted. You'll see the cost drop in your next billing cycle.

---

**Need help?** See [SETUP_GKE_CONNECTION.md](SETUP_GKE_CONNECTION.md) for more details on what each resource does.
